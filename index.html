<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market v4.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-color: #f0f0f0;
            --shadow-sm: 0 2px 10px rgba(0,0,0,0.08);
            --shadow-md: 0 2px 15px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 20px rgba(0,0,0,0.15);
            --navbar-height: 60px;
            --accent-color: #667eea;
            --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            padding-top: var(--navbar-height);
            transition: background 0.3s ease, color 0.3s ease;
        }

        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-tertiary: #808080;
            --border-color: #404040;
        }

        /* NAVBAR */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: #000000;
            box-shadow: var(--shadow-md);
            padding: 0 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }

        .navbar-left {
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 0.5px;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            color: white;
            transition: all 0.3s;
            padding: 5px 8px;
            border-radius: 8px;
            min-width: 50px;
            position: relative;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.25);
        }

        .badge {
            position: absolute;
            top: -3px;
            right: -8px;
            background: #ff4757;
            color: white;
            border-radius: 10px;
            padding: 2px 5px;
            font-size: 9px;
            font-weight: bold;
        }

        /* RECHERCHE AVANCÉE */
        .search-toggle-btn {
            position: fixed;
            top: var(--navbar-height);
            left: 10%;
            transform: translateX(-50%);
            background: #1c1c1c;
            border: none;
            border-radius: 0 0 12px 12px;
            width: 60px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .search-panel {
            position: fixed;
            bottom: -350px;
            left: 0;
            right: 0;
            height: 350px;
            background: var(--bg-secondary);
            border-top: 3px solid #667eea;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            z-index: 998;
            transition: bottom 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            padding: 25px 20px;
            overflow-y: auto;
        }

        .search-panel.show {
            bottom: 0;
        }

        .search-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .search-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            position: relative;
        }

        .search-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .search-tab:hover {
            color: #667eea;
        }

        .search-content {
            display: none;
        }

        .search-content.active {
            display: block;
        }

        .search-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-input {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-btn {
            padding: 12px 24px;
            background: var(--accent-gradient);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .une-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
            margin-top: 10px;
        }

        .une-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
        }

        /* CONTENEUR PRINCIPAL */
        .spa-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            margin-top: 30px;
        }

        /* CARTE ARTICLE */
        .article-card {
            background: var(--bg-secondary);
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .article-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        /* CARTE VIDÉO - DESIGN MODERNE */
        .video-card {
            background: var(--bg-secondary);
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .video-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }

        .video-card:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.25);
        }

        .video-header {
            padding: 15px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-bottom: 1px solid var(--border-color);
        }

        .video-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 17px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            flex-shrink: 0;
        }

        .video-player-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            background: #000;
            overflow: hidden;
        }

        .video-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .video-content {
            padding: 18px;
        }

        .video-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .video-title i {
            color: #667eea;
            font-size: 20px;
        }

        .video-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        /* RÉACTIONS */
        .reactions {
            display: flex;
            gap: 10px;
            padding: 12px 15px;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }

        .reaction-btn {
            flex: 1;
            background: none;
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 16px;
            transition: all 0.3s;
            color: var(--text-secondary);
        }

        .reaction-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.08);
        }

        .reaction-btn.active {
            animation: reactionPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .reaction-btn.active-like {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .reaction-btn.active-love {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .reaction-btn.active-rire {
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .reaction-btn.active-colere {
            color: #dc2626;
            background: rgba(220, 38, 38, 0.1);
        }

        @keyframes reactionPop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .comment-count-badge {
            background: #667eea;
            color: white;
            border-radius: 12px;
            padding: 3px 10px;
            font-size: 12px;
            font-weight: 700;
            min-width: 24px;
            text-align: center;
            animation: bounceIn 0.5s ease;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .comments-reactions-section {
            display: flex;
            border-top: 1px solid var(--border-color);
        }

        .comments-toggle-large {
            flex: 1;
            padding: 15px;
            cursor: pointer;
            color: #667eea;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            font-size: 14px;
            border-right: 1px solid var(--border-color);
        }

        .comments-toggle-large:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .share-btn {
            width: 60px;
            padding: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            background: rgba(34, 197, 94, 0.03);
        }

        .share-btn:hover {
            background: rgba(34, 197, 94, 0.1);
        }

        .comments-section {
            display: none;
            padding: 0 15px 15px;
        }

        .comments-section.show {
            display: block;
        }

        .loader {
            text-align: center;
            padding: 30px;
        }

        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .search-tabs {
                flex-wrap: wrap;
            }
            
            .search-tab {
                padding: 8px 15px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-left">Market v4.0</div>
        <div class="navbar-center">
            <button class="theme-toggle" id="theme-toggle">
                <i class="fas fa-moon" id="theme-icon"></i>
            </button>
        </div>
        <div class="navbar-right" style="display: flex; gap: 20px;">
            <div class="nav-item active" data-page="home">
                <i class="fas fa-home"></i>
                <span>Accueil</span>
            </div>
            <div class="nav-item" data-page="messages">
                <i class="fas fa-envelope"></i>
                <span>Messages</span>
                <span class="badge" id="message-badge" style="display: none;">0</span>
            </div>
            <div class="nav-item" data-page="notifications">
                <i class="fas fa-bell"></i>
                <span>Notifications</span>
                <span class="badge" id="notif-badge" style="display: none;">0</span>
            </div>
            <div class="nav-item">
                <i class="fas fa-bars"></i>
                <span>Menu</span>
            </div>
        </div>
    </nav>

    <button class="search-toggle-btn" id="search-toggle-btn">
        <i class="fas fa-chevron-down"></i>
    </button>

    <div class="search-panel" id="search-panel">
        <div class="search-tabs">
            <button class="search-tab active" data-tab="articles">
                <i class="fas fa-newspaper"></i> Articles
            </button>
            <button class="search-tab" data-tab="videos">
                <i class="fas fa-video"></i> Vidéos
            </button>
            <button class="search-tab" data-tab="une">
                <i class="fas fa-star"></i> À la Une
            </button>
        </div>

        <div class="search-content active" id="search-articles">
            <div class="search-input-container">
                <input type="text" class="search-input" id="search-articles-input" placeholder="Rechercher des articles...">
                <button class="search-btn" id="search-articles-btn">
                    <i class="fas fa-search"></i> Rechercher
                </button>
            </div>
            <div id="articles-results" style="display:none; color: var(--text-secondary); font-size: 14px; padding: 10px; background: var(--bg-primary); border-radius: 8px;"></div>
        </div>

        <div class="search-content" id="search-videos">
            <div class="search-input-container">
                <input type="text" class="search-input" id="search-videos-input" placeholder="Rechercher des vidéos...">
                <button class="search-btn" id="search-videos-btn">
                    <i class="fas fa-search"></i> Rechercher
                </button>
            </div>
            <div id="videos-results" style="display:none; color: var(--text-secondary); font-size: 14px; padding: 10px; background: var(--bg-primary); border-radius: 8px;"></div>
        </div>

        <div class="search-content" id="search-une">
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 15px;">
                Découvrez les contenus mis en avant
            </p>
            <button class="une-btn" onclick="window.location.href='une.html'">
                <i class="fas fa-star"></i> Voir À la Une
            </button>
        </div>
    </div>

    <div class="spa-container">
        <div id="home-page" class="spa-page active">
            <div id="loader" class="loader">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: var(--text-tertiary);">Chargement du contenu...</p>
            </div>
            <div id="content-container"></div>
        </div>
    </div>

    <script src="supabaseClient.js"></script>
    <script src="commentaires.js"></script>
    <script src="vidcomment.js"></script>
    <script src="videreact.js"></script> <script>
        const { supabase, getCurrentUser, getUserProfile } = window.supabaseClient;
        let currentUser = null;
        let userProfile = null;
        let allContent = [];
        let userReactionsCache = {};
        let commentCountsCache = {};

        // THÈME
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const body = document.body;

        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
            themeIcon.classList.replace('fa-moon', 'fa-sun');
        }

        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            if (body.classList.contains('dark-mode')) {
                themeIcon.classList.replace('fa-moon', 'fa-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.classList.replace('fa-sun', 'fa-moon');
                localStorage.setItem('theme', 'light');
            }
        });

        // RECHERCHE - TABS
        document.querySelectorAll('.search-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.search-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.search-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`search-${tab.dataset.tab}`).classList.add('active');
            });
        });

        // RECHERCHE - PANEL TOGGLE
        const searchToggleBtn = document.getElementById('search-toggle-btn');
        const searchPanel = document.getElementById('search-panel');

        searchToggleBtn.addEventListener('click', () => {
            searchPanel.classList.toggle('show');
            searchToggleBtn.classList.toggle('active');
        });

        // RECHERCHE - ARTICLES
        document.getElementById('search-articles-btn').addEventListener('click', () => {
            const query = document.getElementById('search-articles-input').value.trim().toLowerCase();
            if (!query) return;
            
            const filtered = allContent.filter(item => 
                item.type === 'article' && 
                (item.texte?.toLowerCase().includes(query) || 
                 `${item.users_profile?.prenom} ${item.users_profile?.nom}`.toLowerCase().includes(query))
            );
            
            document.getElementById('articles-results').style.display = 'block';
            document.getElementById('articles-results').innerHTML = `<i class="fas fa-check-circle"></i> ${filtered.length} article(s) trouvé(s)`;
            displayContent(filtered);
            setTimeout(() => searchPanel.classList.remove('show'), 500);
        });

        // RECHERCHE - VIDÉOS
        document.getElementById('search-videos-btn').addEventListener('click', () => {
            const query = document.getElementById('search-videos-input').value.trim().toLowerCase();
            if (!query) return;
            
            const filtered = allContent.filter(item => 
                item.type === 'video' && 
                (item.titre?.toLowerCase().includes(query) || 
                 item.description?.toLowerCase().includes(query) ||
                 `${item.users_profile?.prenom} ${item.users_profile?.nom}`.toLowerCase().includes(query))
            );
            
            document.getElementById('videos-results').style.display = 'block';
            document.getElementById('videos-results').innerHTML = `<i class="fas fa-check-circle"></i> ${filtered.length} vidéo(s) trouvée(s)`;
            displayContent(filtered);
            setTimeout(() => searchPanel.classList.remove('show'), 500);
        });

        // INIT
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                currentUser = await getCurrentUser();
                if (currentUser) {
                    userProfile = await getUserProfile(currentUser.id);
                }
                await loadAllContent();
            } catch (error) {
                console.error("Erreur init:", error);
            }
        });

        async function loadAllContent() {
            try {
                const [articlesResult, videosResult] = await Promise.all([
                    supabase.from('articles').select(`*, users_profile(prenom, nom, role), article_images(image_url)`).order('date_created', { ascending: false }),
                    supabase.from('videos').select(`*, users_profile(prenom, nom, role)`).order('date_created', { ascending: false })
                ]);

                document.getElementById('loader').style.display = 'none';

                const articles = (articlesResult.data || []).map(a => ({ ...a, type: 'article' }));
                const videos = (videosResult.data || []).map(v => ({ ...v, type: 'video' }));

                await loadAllReactionCounts(articles, videos);
                await loadCommentCounts();

                if (currentUser) {
                    await loadUserReactions();
                }

                allContent = [...articles, ...videos].sort((a, b) => new Date(b.date_created) - new Date(a.date_created));
                displayContent(allContent);
            } catch (error) {
                console.error('Erreur chargement:', error);
            }
        }

        async function loadAllReactionCounts(articles, videos) {
            try {
                const articleIds = articles.map(a => a.article_id);
                if (articleIds.length > 0) {
                    const { data: articleReactions } = await supabase.from('article_reactions').select('article_id, reaction_type').in('article_id', articleIds);
                    const reactionsByArticle = {};
                    articleReactions?.forEach(r => {
                        if (!reactionsByArticle[r.article_id]) {
                            reactionsByArticle[r.article_id] = { like: 0, love: 0, rire: 0, colere: 0 };
                        }
                        reactionsByArticle[r.article_id][r.reaction_type]++;
                    });
                    articles.forEach(article => {
                        const counts = reactionsByArticle[article.article_id] || { like: 0, love: 0, rire: 0, colere: 0 };
                        article.reaction_like = counts.like;
                        article.reaction_love = counts.love;
                        article.reaction_rire = counts.rire;
                        article.reaction_colere = counts.colere;
                    });
                }

                const videoIds = videos.map(v => v.video_id);
                if (videoIds.length > 0) {
                    const { data: videoReactions } = await supabase.from('video_reactions').select('video_id, reaction_type').in('video_id', videoIds);
                    const reactionsByVideo = {};
                    videoReactions?.forEach(r => {
                        if (!reactionsByVideo[r.video_id]) {
                            reactionsByVideo[r.video_id] = { like: 0, love: 0, rire: 0, colere: 0 };
                        }
                        reactionsByVideo[r.video_id][r.reaction_type]++;
                    });
                    videos.forEach(video => {
                        const counts = reactionsByVideo[video.video_id] || { like: 0, love: 0, rire: 0, colere: 0 };
                        video.reaction_like = counts.like;
                        video.reaction_love = counts.love;
                        video.reaction_rire = counts.rire;
                        video.reaction_colere = counts.colere;
                    });
                }
            } catch (error) {
                console.error('Erreur compteurs réactions:', error);
            }
        }

        async function loadCommentCounts() {
            try {
                const { data: counts } = await supabase.from('commentaires_count').select('content_id, content_type, total_comments');
                commentCountsCache = {};
                counts?.forEach(c => {
                    commentCountsCache[c.content_id] = c.total_comments;
                });
            } catch (error) {
                console.error('Erreur compteurs commentaires:', error);
            }
        }

        async function loadUserReactions() {
            try {
                const [articleReactions, videoReactions] = await Promise.all([
                    supabase.from('article_reactions').select('article_id, reaction_type').eq('user_id', currentUser.id),
                    supabase.from('video_reactions').select('video_id, reaction_type').eq('user_id', currentUser.id)
                ]);
                
                userReactionsCache = {};
                articleReactions.data?.forEach(r => {
                    userReactionsCache[r.article_id] = r.reaction_type;
                });
                videoReactions.data?.forEach(r => {
                    userReactionsCache[r.video_id] = r.reaction_type;
                });
            } catch (error) {
                console.error('Erreur réactions utilisateur:', error);
            }
        }

        function displayContent(content) {
            const container = document.getElementById('content-container');
            container.innerHTML = '';
            
            if (content.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:50px; color:var(--text-tertiary);"><i class="fas fa-inbox" style="font-size:50px; margin-bottom:15px;"></i><p>Aucun contenu trouvé</p></div>';
                return;
            }
            
            content.forEach(item => {
                if (item.type === 'video') {
                    container.appendChild(createVideoCard(item));
                } else {
                    container.appendChild(createArticleCard(item));
                }
            });
        }

        function createArticleCard(article) {
            const card = document.createElement('div');
            card.className = 'article-card';
            const author = article.users_profile || { prenom: 'Utilisateur', nom: '' };
            const initials = `${author.prenom[0]}${author.nom[0]}`.toUpperCase();
            const userReaction = userReactionsCache[article.article_id];
            const commentCount = commentCountsCache[article.article_id] || 0;

            card.innerHTML = `
                <div style="padding: 12px 15px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border-color);">
                    <div style="width:40px; height:40px; border-radius:50%; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:16px;">${initials}</div>
                    <div style="flex:1;">
                        <h3 style="font-size:15px; color:var(--text-primary); margin-bottom:2px;">${author.prenom} ${author.nom}</h3>
                        <p style="font-size:11px; color:var(--text-tertiary);">${new Date(article.date_created).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                    </div>
                </div>
                <div style="padding: 15px;">
                    <div style="color:var(--text-primary); line-height:1.6; margin-bottom:12px; font-size:14px;">${article.texte || ''}</div>
                </div>
                <div class="reactions">
                    <button class="reaction-btn ${userReaction === 'like' ? 'active active-like' : ''}" onclick="handleArticleReaction('${article.article_id}', 'like')">
                        <i class="fas fa-thumbs-up"></i><span>${article.reaction_like || 0}</span>
                    </button>
                    <button class="reaction-btn ${userReaction === 'love' ? 'active active-love' : ''}" onclick="handleArticleReaction('${article.article_id}', 'love')">
                        <i class="fas fa-heart"></i><span>${article.reaction_love || 0}</span>
                    </button>
                    <button class="reaction-btn ${userReaction === 'rire' ? 'active active-rire' : ''}" onclick="handleArticleReaction('${article.article_id}', 'rire')">
                        <i class="fas fa-laugh"></i><span>${article.reaction_rire || 0}</span>
                    </button>
                    <button class="reaction-btn ${userReaction === 'colere' ? 'active active-colere' : ''}" onclick="handleArticleReaction('${article.article_id}', 'colere')">
                        <i class="fas fa-angry"></i><span>${article.reaction_colere || 0}</span>
                    </button>
                </div>
                <div class="comments-reactions-section">
                    <div class="comments-toggle-large" onclick="toggleArticleComments('${article.article_id}')">
                        <i class="fas fa-comment"></i><span>Commentaires</span>
                        ${commentCount > 0 ? `<span class="comment-count-badge">${commentCount}</span>` : ''}
                    </div>
                    <div class="share-btn" onclick="shareContent('article', '${article.article_id}', '${encodeURIComponent(article.texte || '')}')">
                        <i class="fas fa-share-alt"></i>
                    </div>
                </div>
                <div class="comments-section" id="comments-article-${article.article_id}"></div>
            `;
            return card;
        }

        function createVideoCard(video) {
            const card = document.createElement('div');
            card.className = 'video-card';
            const author = video.users_profile || { prenom: 'Utilisateur', nom: '' };
            const initials = `${author.prenom[0]}${author.nom[0]}`.toUpperCase();
            const userReaction = userReactionsCache[video.video_id];
            const commentCount = commentCountsCache[video.video_id] || 0;

            card.innerHTML = `
                <div class="video-header">
                    <div class="video-avatar">${initials}</div>
                    <div style="flex:1;">
                        <h3 style="font-size:16px; color:var(--text-primary); margin-bottom:2px; font-weight:700;">${author.prenom} ${author.nom}</h3>
                        <p style="font-size:12px; color:var(--text-tertiary);">${new Date(video.date_created).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                    </div>
                </div>
                <div class="video-content">
                    <div class="video-title">
                        <i class="fas fa-video"></i>
                        <span>${video.titre}</span>
                    </div>
                    ${video.description ? `<div class="video-description">${video.description}</div>` : ''}
                </div>
                <div class="video-player-wrapper">
                    <video controls class="video-player" preload="metadata" playsinline>
                        <source src="${video.video_url}" type="video/mp4">
                        Votre navigateur ne supporte pas la lecture de vidéos.
                    </video>
                </div>
                <div class="reactions">
                    <button class="reaction-btn ${userReaction === 'like' ? 'active active-like' : ''}" onclick="handleVideoReaction('${video.video_id}', 'like')">
                        <i class="fas fa-thumbs-up"></i><span>${video.reaction_like || 0}</span>
                    </button>
                    <button class="reaction-btn ${userReaction === 'love' ? 'active active-love' : ''}" onclick="handleVideoReaction('${video.video_id}', 'love')">
                        <i class="fas fa-heart"></i><span>${video.reaction_love || 0}</span>
                    </button>
                    <button class="reaction-btn ${userReaction === 'rire' ? 'active active-rire' : ''}" onclick="handleVideoReaction('${video.video_id}', 'rire')">
                        <i class="fas fa-laugh"></i><span>${video.reaction_rire || 0}</span>
                    </button>
                    <button class="reaction-btn ${userReaction === 'colere' ? 'active active-colere' : ''}" onclick="handleVideoReaction('${video.video_id}', 'colere')">
                        <i class="fas fa-angry"></i><span>${video.reaction_colere || 0}</span>
                    </button>
                    <button class="reaction-btn" onclick="VideoReactions.show('${video.video_id}')" title="Voir qui a réagi">
                        <i class="fas fa-users"></i>
                    </button>
                </div>
                <div class="comments-reactions-section">
                    <div class="comments-toggle-large" onclick="toggleVideoComments('${video.video_id}')">
                        <i class="fas fa-comment"></i><span>Commentaires</span>
                        ${commentCount > 0 ? `<span class="comment-count-badge">${commentCount}</span>` : ''}
                    </div>
                    <div class="share-btn" onclick="shareContent('video', '${video.video_id}', '${encodeURIComponent(video.titre)}')">
                        <i class="fas fa-share-alt"></i>
                    </div>
                </div>
                <div class="comments-section" id="comments-video-${video.video_id}"></div>
            `;
            return card;
        }

        async function handleArticleReaction(articleId, reactionType) {
            if (!currentUser) {
                alert('Connectez-vous pour réagir.');
                window.location.href = 'connexion.html';
                return;
            }

            try {
                const { data: existing } = await supabase
                    .from('article_reactions')
                    .select('reaction_id, reaction_type')
                    .eq('article_id', articleId)
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (existing) {
                    await supabase.from('article_reactions').delete().eq('reaction_id', existing.reaction_id);
                    if (existing.reaction_type !== reactionType) {
                        await supabase.from('article_reactions').insert({ article_id: articleId, user_id: currentUser.id, reaction_type: reactionType });
                        userReactionsCache[articleId] = reactionType;
                    } else {
                        delete userReactionsCache[articleId];
                    }
                } else {
                    await supabase.from('article_reactions').insert({ article_id: articleId, user_id: currentUser.id, reaction_type: reactionType });
                    userReactionsCache[articleId] = reactionType;
                }

                await updateArticleReactionCountsOnly(articleId);
            } catch (error) {
                console.error('Erreur réaction article:', error);
            }
        }

        async function handleVideoReaction(videoId, reactionType) {
            if (!currentUser) {
                alert('Connectez-vous pour réagir.');
                window.location.href = 'connexion.html';
                return;
            }

            try {
                const { data: existing } = await supabase
                    .from('video_reactions')
                    .select('reaction_id, reaction_type')
                    .eq('video_id', videoId)
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (existing) {
                    await supabase.from('video_reactions').delete().eq('reaction_id', existing.reaction_id);
                    if (existing.reaction_type !== reactionType) {
                        await supabase.from('video_reactions').insert({ video_id: videoId, user_id: currentUser.id, reaction_type: reactionType });
                        userReactionsCache[videoId] = reactionType;
                    } else {
                        delete userReactionsCache[videoId];
                    }
                } else {
                    await supabase.from('video_reactions').insert({ video_id: videoId, user_id: currentUser.id, reaction_type: reactionType });
                    userReactionsCache[videoId] = reactionType;
                }

                await updateVideoReactionCountsOnly(videoId);
            } catch (error) {
                console.error('Erreur réaction vidéo:', error);
            }
        }

        async function updateArticleReactionCountsOnly(articleId) {
            try {
                const { data: counts } = await supabase
                    .from('article_reactions')
                    .select('reaction_type')
                    .eq('article_id', articleId);

                const reactionCounts = { like: 0, love: 0, rire: 0, colere: 0 };
                counts?.forEach(r => reactionCounts[r.reaction_type]++);

                const card = document.querySelector(`#comments-article-${articleId}`)?.closest('.article-card');
                if (card) {
                    const reactionBtns = card.querySelectorAll('.reaction-btn');
                    const userReaction = userReactionsCache[articleId];
                    const types = ['like', 'love', 'rire', 'colere'];
                    reactionBtns.forEach((btn, index) => {
                        const type = types[index];
                        const span = btn.querySelector('span');
                        if (span) span.textContent = reactionCounts[type];
                        btn.classList.remove('active', 'active-like', 'active-love', 'active-rire', 'active-colere');
                        if (userReaction === type) btn.classList.add('active', `active-${type}`);
                    });
                }
            } catch (error) {
                console.error('Erreur mise à jour compteurs article:', error);
            }
        }

        async function updateVideoReactionCountsOnly(videoId) {
            try {
                const { data: counts } = await supabase
                    .from('video_reactions')
                    .select('reaction_type')
                    .eq('video_id', videoId);

                const reactionCounts = { like: 0, love: 0, rire: 0, colere: 0 };
                counts?.forEach(r => reactionCounts[r.reaction_type]++);

                const card = document.querySelector(`#comments-video-${videoId}`)?.closest('.video-card');
                if (card) {
                    const reactionBtns = card.querySelectorAll('.reaction-btn');
                    const userReaction = userReactionsCache[videoId];
                    const types = ['like', 'love', 'rire', 'colere'];
                    reactionBtns.forEach((btn, index) => {
                        const type = types[index];
                        const span = btn.querySelector('span');
                        if (span) span.textContent = reactionCounts[type];
                        btn.classList.remove('active', 'active-like', 'active-love', 'active-rire', 'active-colere');
                        if (userReaction === type) btn.classList.add('active', `active-${type}`);
                    });
                }
            } catch (error) {
                console.error('Erreur mise à jour compteurs vidéo:', error);
            }
        }

        function toggleArticleComments(articleId) {
            const section = document.getElementById(`comments-article-${articleId}`);
            if (section) {
                section.classList.toggle('show');
                if (section.classList.contains('show') && section.innerHTML.trim() === '') {
                    loadArticleComments(articleId, section);
                }
            }
        }

        function toggleVideoComments(videoId) {
            const section = document.getElementById(`comments-video-${videoId}`);
            if (section) {
                section.classList.toggle('show');
                if (section.classList.contains('show') && section.innerHTML.trim() === '') {
                    loadVideoComments(videoId, section);
                }
            }
        }

        async function loadArticleComments(articleId, container) {
            container.innerHTML = '<div class="loader"><div class="spinner"></div></div>';
            try {
                const { data: comments } = await supabase
                    .from('sessions_commentaires')
                    .select(`*, users_profile(prenom, nom)`)
                    .eq('article_id', articleId)
                    .order('date_created', { ascending: false });
                
                if (window.CommentsWidget) {
                    window.CommentsWidget.render(container, articleId, comments, currentUser, userProfile);
                } else {
                    container.innerHTML = '<p style="padding:20px; color:red;">Module commentaires non chargé</p>';
                }
            } catch (error) {
                console.error('Erreur commentaires article:', error);
                container.innerHTML = '<p style="padding:20px; color:red;">Erreur de chargement</p>';
            }
        }

        async function loadVideoComments(videoId, container) {
            container.innerHTML = '<div class="loader"><div class="spinner"></div></div>';
            try {
                const { data: comments } = await supabase
                    .from('video_commentaires')
                    .select(`*, users_profile(prenom, nom)`)
                    .eq('video_id', videoId)
                    .order('date_created', { ascending: false });
                
                if (window.VideoCommentsWidget) {
                    window.VideoCommentsWidget.render(container, videoId, comments, currentUser, userProfile);
                } else {
                    container.innerHTML = '<p style="padding:20px; color:red;">Module commentaires vidéo non chargé</p>';
                }
            } catch (error) {
                console.error('Erreur commentaires vidéo:', error);
                container.innerHTML = '<p style="padding:20px; color:red;">Erreur de chargement</p>';
            }
        }

        function shareContent(type, id, text) {
            const url = `${window.location.origin}?${type}=${id}`;
            const title = type === 'video' ? 'Vidéo Market' : 'Article Market';
            
            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: decodeURIComponent(text).substring(0, 100),
                    url: url
                }).catch(err => console.log('Partage annulé'));
            } else {
                prompt('Copiez ce lien:', url);
            }
        }

        window.handleArticleReaction = handleArticleReaction;
        window.handleVideoReaction = handleVideoReaction;
        window.toggleArticleComments = toggleArticleComments;
        window.toggleVideoComments = toggleVideoComments;
        window.shareContent = shareContent;

        console.log('%c✅ Market App v4.0 Chargée', 'color: #22c55e; font-weight: bold; font-size: 16px;');
    </script>
</body>
</html>
