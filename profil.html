<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil - Market</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f3f5;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-tertiary: #868e96;
            --border-color: #dee2e6;
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
            --shadow-xl: 0 12px 32px rgba(0,0,0,0.2);
            --bottom-nav-height: 70px;
            --transition-base: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #242424;
            --bg-tertiary: #2d2d2d;
            --text-primary: #e9ecef;
            --text-secondary: #ced4da;
            --text-tertiary: #adb5bd;
            --border-color: #343a40;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
            --shadow-xl: 0 12px 32px rgba(0,0,0,0.6);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding-bottom: var(--bottom-nav-height);
            transition: var(--transition-base);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ============================================
           HEADER PROFIL ANIMÉ
        ============================================ */
        .profile-header {
            position: relative;
            background: var(--accent-gradient);
            padding: 40px 20px 80px;
            text-align: center;
            overflow: hidden;
        }

        .profile-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
            animation: backgroundScroll 20s linear infinite;
        }

        @keyframes backgroundScroll {
            0% { transform: translate(0, 0); }
            100% { transform: translate(60px, 60px); }
        }

        .profile-avatar-container {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
            animation: bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounceIn {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 800;
            color: var(--accent-primary);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            border: 6px solid white;
            position: relative;
            z-index: 1;
        }

        .profile-avatar::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            border: 3px dashed rgba(255,255,255,0.3);
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .profile-name {
            font-size: 28px;
            font-weight: 800;
            color: white;
            margin-bottom: 8px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.2);
            animation: slideInDown 0.6s ease 0.2s both;
        }

        @keyframes slideInDown {
            0% { transform: translateY(-30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .profile-role {
            display: inline-block;
            padding: 8px 20px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: slideInUp 0.6s ease 0.3s both;
        }

        @keyframes slideInUp {
            0% { transform: translateY(30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        /* ============================================
           STATS ANIMÉES
        ============================================ */
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            padding: 0 20px;
            margin-top: -50px;
            position: relative;
            z-index: 2;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            animation: fadeInUp 0.6s ease both;
            transition: var(--transition-base);
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }

        @keyframes fadeInUp {
            0% { transform: translateY(30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            background: var(--accent-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .stat-number {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ============================================
           MINI GAME
        ============================================ */
        .game-section {
            margin: 24px 20px;
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            animation: fadeIn 0.6s ease 0.4s both;
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .game-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
        }

        .game-score {
            background: var(--accent-gradient);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
        }

        #gameCanvas {
            width: 100%;
            height: 250px;
            background: linear-gradient(180deg, #87ceeb 0%, #e0f6ff 100%);
            border-radius: 16px;
            cursor: pointer;
            touch-action: none;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
        }

        .game-controls {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .game-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-base);
            font-size: 14px;
        }

        .game-btn-start {
            background: var(--accent-gradient);
            color: white;
        }

        .game-btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .game-btn-pause {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .game-btn-pause:hover {
            background: var(--accent-primary);
            color: white;
        }

        /* ============================================
           ARTICLES SECTION
        ============================================ */
        .articles-section {
            margin: 0 20px 24px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            animation: slideInLeft 0.6s ease 0.5s both;
        }

        @keyframes slideInLeft {
            0% { transform: translateX(-30px); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        .section-title {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-count {
            background: var(--accent-gradient);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        /* Articles Cards - Same as index.html */
        .article-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: var(--transition-base);
            border: 1px solid var(--border-color);
            animation: scaleIn 0.4s ease both;
        }

        @keyframes scaleIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .article-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .article-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        /* OPTIONS MENU */
        .options-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-base);
            color: var(--text-secondary);
            margin-left: auto;
        }

        .options-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .options-menu {
            display: none;
            position: absolute;
            top: 50px;
            right: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            min-width: 180px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            z-index: 10;
        }

        .options-menu.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .options-menu-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition-base);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
        }

        .options-menu-item:hover {
            background: var(--bg-tertiary);
        }

        .options-menu-item.delete {
            color: #ff4757;
        }

        .options-menu-item.delete:hover {
            background: rgba(255, 71, 87, 0.1);
        }

        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            flex-shrink: 0;
        }

        .author-info {
            flex: 1;
            min-width: 0;
        }

        .author-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .author-date {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .article-content {
            padding: 20px;
        }

        .article-text {
            color: var(--text-primary);
            line-height: 1.7;
            margin-bottom: 16px;
            font-size: 15px;
        }

        .article-images {
            display: grid;
            gap: 8px;
            margin-top: 16px;
            border-radius: 12px;
            overflow: hidden;
        }

        .article-images.single { grid-template-columns: 1fr; }
        .article-images.double { grid-template-columns: repeat(2, 1fr); }
        .article-images.multiple { grid-template-columns: repeat(2, 1fr); }

        .article-images img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: var(--transition-base);
        }

        .article-images img:hover {
            transform: scale(1.05);
        }

        .article-links {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .link-btn {
            flex: 1;
            padding: 10px;
            background: var(--accent-gradient);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .link-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .reactions {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }

        .reaction-btn {
            flex: 1;
            background: transparent;
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 16px;
            transition: var(--transition-base);
            color: var(--text-secondary);
        }

        .reaction-btn:hover {
            background: var(--bg-tertiary);
            transform: scale(1.05);
            border-color: var(--accent-primary);
        }

        .reaction-btn.active-like {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .reaction-btn.active-love {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #ef4444;
        }

        .reaction-btn.active-rire {
            background: rgba(245, 158, 11, 0.1);
            border-color: #f59e0b;
            color: #f59e0b;
        }

        .reaction-btn.active-colere {
            background: rgba(220, 38, 38, 0.1);
            border-color: #dc2626;
            color: #dc2626;
        }

        .reaction-btn span {
            font-size: 14px;
            font-weight: 600;
        }

        .comments-section-bar {
            display: flex;
            border-top: 1px solid var(--border-color);
        }

        .comment-toggle-btn {
            flex: 1;
            padding: 16px;
            background: transparent;
            border: none;
            color: var(--accent-primary);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition-base);
            border-right: 1px solid var(--border-color);
        }

        .comment-toggle-btn:hover {
            background: var(--bg-tertiary);
        }

        .comment-count-badge {
            background: var(--accent-primary);
            color: white;
            border-radius: 12px;
            padding: 2px 10px;
            font-size: 12px;
            font-weight: 700;
        }

        .action-btn {
            padding: 16px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-base);
            color: var(--text-secondary);
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--accent-primary);
        }

        .action-btn i {
            font-size: 20px;
        }

        .comments-container {
            display: none;
            padding: 20px;
            background: var(--bg-primary);
        }

        .comments-container.show {
            display: block;
        }

        /* ============================================
           BOTTOM NAVIGATION
        ============================================ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--bottom-nav-height);
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            border-top: 1px solid var(--border-color);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition-base);
            color: var(--text-tertiary);
            text-decoration: none;
            position: relative;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--accent-primary);
        }

        .nav-item.active {
            background: var(--accent-gradient);
            color: white;
        }

        .nav-item i {
            font-size: 22px;
        }

        .nav-item span {
            font-size: 11px;
            font-weight: 600;
        }

        .nav-badge {
            position: absolute;
            top: 4px;
            right: 8px;
            background: #ff4757;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(255, 71, 87, 0.4);
        }

        /* ============================================
           LOADER & EMPTY STATE
        ============================================ */
        .loader {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-tertiary);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        /* ============================================
           RESPONSIVE
        ============================================ */
        @media (max-width: 768px) {
            .profile-stats {
                gap: 12px;
                padding: 0 16px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-number {
                font-size: 20px;
            }

            .game-section,
            .articles-section {
                margin-left: 16px;
                margin-right: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- PROFILE HEADER -->
    <div class="profile-header">
        <div class="profile-avatar-container">
            <div class="profile-avatar" id="profileAvatar">
                <i class="fas fa-user"></i>
            </div>
        </div>
        <div class="profile-name" id="profileName">Chargement...</div>
        <div class="profile-role" id="profileRole">...</div>
    </div>

    <!-- STATS -->
    <div class="profile-stats">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-newspaper"></i>
            </div>
            <div class="stat-number" id="articleCount">0</div>
            <div class="stat-label">Articles</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-heart"></i>
            </div>
            <div class="stat-number" id="reactionCount">0</div>
            <div class="stat-label">Réactions</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-comment"></i>
            </div>
            <div class="stat-number" id="commentCount">0</div>
            <div class="stat-label">Commentaires</div>
        </div>
    </div>

    <!-- MINI GAME -->
    <div class="game-section">
        <div class="game-header">
            <div class="game-title">
                <i class="fas fa-gamepad"></i>
                Course Infinie
            </div>
            <div class="game-score">
                Score: <span id="gameScore">0</span> | Level: <span id="gameLevel">1</span>
            </div>
        </div>
        <canvas id="gameCanvas"></canvas>
        <div class="game-controls">
            <button class="game-btn game-btn-start" id="startBtn">
                <i class="fas fa-play"></i> Commencer
            </button>
            <button class="game-btn game-btn-pause" id="pauseBtn" style="display: none;">
                <i class="fas fa-pause"></i> Pause
            </button>
        </div>
    </div>

    <!-- ARTICLES SECTION -->
    <div class="articles-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-newspaper"></i>
                Mes Articles
                <span class="section-count" id="articleCountBadge">0</span>
            </div>
        </div>
        <div id="loader" class="loader">
            <div class="spinner"></div>
            <p style="margin-top: 16px; color: var(--text-tertiary); font-weight: 500;">Chargement...</p>
        </div>
        <div id="articlesContainer"></div>
        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="fas fa-inbox"></i>
            <h3>Aucun article publié</h3>
            <p>Commencez à partager votre contenu</p>
        </div>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Accueil</span>
        </a>
        <a href="messages.html" class="nav-item">
            <i class="fas fa-envelope"></i>
            <span>Messages</span>
            <span class="nav-badge" id="messageBadge" style="display: none;">0</span>
        </a>
        <a href="profil.html" class="nav-item active">
            <i class="fas fa-user"></i>
            <span>Profil</span>
        </a>
        <a href="notifications.html" class="nav-item">
            <i class="fas fa-bell"></i>
            <span>Notifications</span>
            <span class="nav-badge" id="notifBadge" style="display: none;">0</span>
        </a>
    </nav>

    <!-- SCRIPTS -->
    <script src="supabaseClient.js"></script>
    <script src="commentaires.js"></script>
    <script>
        const { supabase, getCurrentUser, getUserProfile } = window.supabaseClient;
        let currentUser = null;
        let userProfile = null;
        let userArticles = [];
        let userReactionsCache = {};
        let commentCountsCache = {};

        // GAME VARIABLES - Car Dodging (lane-based)
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameRunning = false;
        let gamePaused = false;
        let score = 0;
        let level = 1;
        let speed = 4; // base speed
        let lanes = 3;
        let laneWidth = 100;
        let roadPadding = 20;
        let player = { lane: 1, x: 0, y: 0, width: 36, height: 60, color: '#2563eb' };
        let cars = [];
        let spawnTimer = 0;
        let spawnInterval = 60; // frames
        let animationId = null;

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            laneWidth = Math.max(80, Math.min(140, Math.floor((canvas.width - roadPadding * 2) / lanes)));
            updatePlayerPosition();
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        function laneX(laneIndex) {
            const roadWidth = laneWidth * lanes;
            const startX = (canvas.width - roadWidth) / 2;
            return Math.floor(startX + laneIndex * laneWidth + (laneWidth - player.width) / 2);
        }

        function updatePlayerPosition() {
            player.x = laneX(player.lane);
            player.y = canvas.height - player.height - 16;
        }

        function startGame() {
            if (gameRunning && !gamePaused) return;
            gameRunning = true;
            gamePaused = false;
            score = 0;
            level = 1;
            speed = 4;
            cars = [];
            spawnTimer = 0;
            player.lane = 1;
            updatePlayerPosition();
            document.getElementById('gameScore').textContent = score;
            document.getElementById('gameLevel').textContent = level;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'block';
            gameLoop();
        }

        function pauseGame() {
            gamePaused = !gamePaused;
            const btn = document.getElementById('pauseBtn');
            if (gamePaused) {
                btn.innerHTML = '<i class="fas fa-play"></i> Continuer';
                cancelAnimationFrame(animationId);
            } else {
                btn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                gameLoop();
            }
        }

        function gameOver() {
            gameRunning = false;
            gamePaused = false;
            cancelAnimationFrame(animationId);
            alert(`Fin de partie ! Score: ${score}`);
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('pauseBtn').style.display = 'none';
        }

        function spawnCar() {
            const lane = Math.floor(Math.random() * lanes);
            const colors = ['#ef4444', '#22c55e', '#f59e0b', '#06b6d4', '#a855f7'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            const height = 60 + Math.floor(Math.random() * 20);
            cars.push({
                lane,
                x: laneX(lane),
                y: -height,
                width: player.width,
                height,
                color,
            });
        }

        function drawRoad() {
            // road background
            ctx.fillStyle = '#2f3640';
            const roadWidth = laneWidth * lanes;
            const roadX = (canvas.width - roadWidth) / 2;
            ctx.fillRect(roadX, 0, roadWidth, canvas.height);

            // lane separators
            ctx.strokeStyle = 'rgba(255,255,255,0.6)';
            ctx.lineWidth = 4;
            ctx.setLineDash([20, 20]);
            for (let i = 1; i < lanes; i++) {
                const x = roadX + i * laneWidth;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            ctx.setLineDash([]);
        }

        function drawCar(car) {
            // body
            ctx.fillStyle = car.color;
            roundRect(ctx, car.x, car.y, car.width, car.height, 8, true, false);
            // windows
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            roundRect(ctx, car.x + 6, car.y + 10, car.width - 12, 14, 4, true, false);
            // wheels
            ctx.fillStyle = '#111827';
            ctx.fillRect(car.x - 4, car.y + 12, 6, 14);
            ctx.fillRect(car.x + car.width - 2, car.y + 12, 6, 14);
            ctx.fillRect(car.x - 4, car.y + car.height - 26, 6, 14);
            ctx.fillRect(car.x + car.width - 2, car.y + car.height - 26, 6, 14);
        }

        function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
            if (typeof radius === 'number') {
                radius = { tl: radius, tr: radius, br: radius, bl: radius };
            }
            ctx.beginPath();
            ctx.moveTo(x + radius.tl, y);
            ctx.lineTo(x + width - radius.tr, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
            ctx.lineTo(x + width, y + height - radius.br);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
            ctx.lineTo(x + radius.bl, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
            ctx.lineTo(x, y + radius.tl);
            ctx.quadraticCurveTo(x, y, x + radius.tl, y);
            ctx.closePath();
            if (fill) ctx.fill();
            if (stroke) ctx.stroke();
        }

        function gameLoop() {
            if (!gameRunning || gamePaused) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawRoad();

            // spawn cars over time
            spawnTimer++;
            if (spawnTimer >= spawnInterval) {
                spawnTimer = 0;
                spawnCar();
            }

            // update cars
            for (let i = cars.length - 1; i >= 0; i--) {
                const car = cars[i];
                car.y += speed;
                drawCar(car);
                // collision
                if (player.lane === car.lane) {
                    const py = player.y, ph = player.height;
                    if (car.y + car.height > py + 6 && car.y < py + ph - 6) {
                        gameOver();
                        return;
                    }
                }
                // remove off-screen and score
                if (car.y > canvas.height) {
                    cars.splice(i, 1);
                    score += 5;
                    document.getElementById('gameScore').textContent = score;
                    if (score % 50 === 0) {
                        level++;
                        document.getElementById('gameLevel').textContent = level;
                        speed = Math.min(12, speed + 0.6);
                        spawnInterval = Math.max(28, spawnInterval - 2);
                    }
                }
            }

            // draw player car on top
            drawCar(player);

            animationId = requestAnimationFrame(gameLoop);
        }

        function moveLeft() {
            if (!gameRunning || gamePaused) return;
            if (player.lane > 0) {
                player.lane--;
                updatePlayerPosition();
            }
        }

        function moveRight() {
            if (!gameRunning || gamePaused) return;
            if (player.lane < lanes - 1) {
                player.lane++;
                updatePlayerPosition();
            }
        }

        // input handlers
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') moveLeft();
            if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') moveRight();
        });

        // swipe
        let touchStartX = null;
        canvas.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
        }, { passive: true });
        canvas.addEventListener('touchend', (e) => {
            if (touchStartX === null) return;
            const dx = e.changedTouches[0].clientX - touchStartX;
            if (Math.abs(dx) > 30) {
                if (dx < 0) moveLeft(); else moveRight();
            }
            touchStartX = null;
        });

        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('pauseBtn').addEventListener('click', pauseGame);

        // INIT APP
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                currentUser = await getCurrentUser();
                if (!currentUser) {
                    window.location.href = 'connexion.html';
                    return;
                }

                userProfile = await getUserProfile(currentUser.id);
                if (!userProfile) {
                    window.location.href = 'connexion.html';
                    return;
                }

                displayProfile();
                await Promise.all([
                    loadUserArticles(),
                    loadUserStats(),
                    loadCommentCounts(),
                    loadUserReactions(),
                    loadNotificationCount(),
                    loadMessageCount()
                ]);

                setupRealtimeSubscriptions();
            } catch (error) {
                console.error('Erreur initialisation:', error);
                window.location.href = 'connexion.html';
            }
        });

        function displayProfile() {
            const initials = `${userProfile.prenom[0]}${userProfile.nom[0]}`.toUpperCase();
            document.getElementById('profileAvatar').textContent = initials;
            document.getElementById('profileName').textContent = `${userProfile.prenom} ${userProfile.nom}`;
            document.getElementById('profileRole').textContent = userProfile.role;
        }

        async function loadUserArticles() {
            try {
                const { data, error } = await supabase
                    .from('articles')
                    .select('*, users_profile(prenom, nom, role), article_images(image_url)')
                    .eq('user_id', currentUser.id)
                    .order('date_created', { ascending: false });

                if (error) throw error;

                userArticles = data || [];
                document.getElementById('articleCount').textContent = userArticles.length;
                document.getElementById('articleCountBadge').textContent = userArticles.length;

                await loadArticleReactionCounts(userArticles);

                document.getElementById('loader').style.display = 'none';

                if (userArticles.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                } else {
                    displayArticles();
                }
            } catch (error) {
                console.error('Erreur chargement articles:', error);
                document.getElementById('loader').innerHTML = 
                    '<p style="color: #ff4757;">Erreur de chargement</p>';
            }
        }

        async function loadArticleReactionCounts(articles) {
            try {
                const articleIds = articles.map(a => a.article_id);
                if (articleIds.length === 0) return;

                const { data } = await supabase
                    .from('article_reactions')
                    .select('article_id, reaction_type')
                    .in('article_id', articleIds);

                const reactionsByArticle = {};
                data?.forEach(r => {
                    if (!reactionsByArticle[r.article_id]) {
                        reactionsByArticle[r.article_id] = { like: 0, love: 0, rire: 0, colere: 0 };
                    }
                    reactionsByArticle[r.article_id][r.reaction_type]++;
                });

                articles.forEach(article => {
                    const counts = reactionsByArticle[article.article_id] || { like: 0, love: 0, rire: 0, colere: 0 };
                    article.reaction_like = counts.like;
                    article.reaction_love = counts.love;
                    article.reaction_rire = counts.rire;
                    article.reaction_colere = counts.colere;
                });
            } catch (error) {
                console.error('Erreur chargement compteurs réactions:', error);
            }
        }

        async function loadUserReactions() {
            try {
                const { data } = await supabase
                    .from('article_reactions')
                    .select('article_id, reaction_type')
                    .eq('user_id', currentUser.id);

                userReactionsCache = {};
                data?.forEach(r => {
                    userReactionsCache[r.article_id] = r.reaction_type;
                });
            } catch (error) {
                console.error('Erreur chargement réactions utilisateur:', error);
            }
        }

        async function loadCommentCounts() {
            try {
                const { data } = await supabase
                    .from('commentaires_count')
                    .select('content_id, total_comments');

                commentCountsCache = {};
                data?.forEach(c => {
                    commentCountsCache[c.content_id] = c.total_comments;
                });
            } catch (error) {
                console.error('Erreur chargement compteurs commentaires:', error);
            }
        }

        async function loadUserStats() {
            try {
                // Total reactions received
                const articleIds = userArticles.map(a => a.article_id);
                if (articleIds.length > 0) {
                    const { count: reactions } = await supabase
                        .from('article_reactions')
                        .select('*', { count: 'exact', head: true })
                        .in('article_id', articleIds);
                    
                    document.getElementById('reactionCount').textContent = reactions || 0;

                    // Total comments received
                    const { count: comments } = await supabase
                        .from('sessions_commentaires')
                        .select('*', { count: 'exact', head: true })
                        .in('article_id', articleIds);
                    
                    document.getElementById('commentCount').textContent = comments || 0;
                }
            } catch (error) {
                console.error('Erreur chargement stats:', error);
            }
        }

        function displayArticles() {
            const container = document.getElementById('articlesContainer');
            container.innerHTML = '';

            userArticles.forEach((article, index) => {
                const card = createArticleCard(article);
                card.style.animationDelay = `${index * 0.1}s`;
                container.appendChild(card);
            });
        }

        function createArticleCard(article) {
            const card = document.createElement('div');
            card.className = 'article-card';

            const author = article.users_profile;
            const initials = `${author.prenom[0]}${author.nom[0]}`.toUpperCase();
            const images = article.article_images || [];
            const imageClass = images.length === 1 ? 'single' : images.length === 2 ? 'double' : 'multiple';
            
            const imagesHTML = images.length > 0 ? `
                <div class="article-images ${imageClass}">
                    ${images.map(img => `<img src="${img.image_url}" alt="Image">`).join('')}
                </div>` : '';

            const linksHTML = (article.texte_url || article.vente_url || article.whatsapp_url) ? `
                <div class="article-links">
                    ${article.texte_url ? `<button class="link-btn" onclick="window.open('${article.texte_url}', '_blank')"><i class="fas fa-link"></i> Lien</button>` : ''}
                    ${article.vente_url ? `<button class="link-btn" onclick="window.open('${article.vente_url}', '_blank')"><i class="fas fa-shopping-cart"></i> Acheter</button>` : ''}
                    ${article.whatsapp_url ? `<button class="link-btn" onclick="window.open('${article.whatsapp_url}', '_blank')"><i class="fab fa-whatsapp"></i> WhatsApp</button>` : ''}
                </div>` : '';

            const userReaction = userReactionsCache[article.article_id];
            const commentCount = commentCountsCache[article.article_id] || 0;

            // Options menu pour l'utilisateur propriétaire
            const optionsHTML = `
                <div style="position: relative;">
                    <button class="options-btn" onclick="toggleOptions(event, '${article.article_id}')">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="options-menu" id="options-${article.article_id}">
                        <div class="options-menu-item" onclick="editArticle('${article.article_id}')">
                            <i class="fas fa-edit"></i> Modifier
                        </div>
                        <div class="options-menu-item delete" onclick="deleteArticle('${article.article_id}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </div>
                    </div>
                </div>
            `;

            card.innerHTML = `
                <div class="article-header">
                    <div class="avatar">${initials}</div>
                    <div class="author-info">
                        <div class="author-name">${author.prenom} ${author.nom}</div>
                        <div class="author-date">${formatDate(article.date_created)}</div>
                    </div>
                    ${optionsHTML}
                </div>
                <div class="article-content">
                    <div class="article-text">${article.texte || ''}</div>
                    ${imagesHTML}
                    ${linksHTML}
                </div>
                <div class="reactions">
                    <button class="reaction-btn ${userReaction === 'like' ? 'active-like' : ''}" 
                            onclick="handleReaction('${article.article_id}', 'like')">
                        <i class="fas fa-thumbs-up"></i>
                        <span>${article.reaction_like || 0}</span>
                    </button>
                    <button class="reaction-btn ${userReaction === 'love' ? 'active-love' : ''}" 
                            onclick="handleReaction('${article.article_id}', 'love')">
                        <i class="fas fa-heart"></i>
                        <span>${article.reaction_love || 0}</span>
                    </button>
                    <button class="reaction-btn ${userReaction === 'rire' ? 'active-rire' : ''}" 
                            onclick="handleReaction('${article.article_id}', 'rire')">
                        <i class="fas fa-laugh"></i>
                        <span>${article.reaction_rire || 0}</span>
                    </button>
                    <button class="reaction-btn ${userReaction === 'colere' ? 'active-colere' : ''}" 
                            onclick="handleReaction('${article.article_id}', 'colere')">
                        <i class="fas fa-angry"></i>
                        <span>${article.reaction_colere || 0}</span>
                    </button>
                </div>
                <div class="comments-section-bar">
                    <button class="comment-toggle-btn" onclick="toggleComments('${article.article_id}')">
                        <i class="fas fa-comment"></i>
                        Commentaires
                        ${commentCount > 0 ? `<span class="comment-count-badge">${commentCount}</span>` : ''}
                    </button>
                    <button class="action-btn" onclick="viewReactions('${article.article_id}')">
                        <i class="fas fa-users"></i>
                    </button>
                    <button class="action-btn" onclick="shareContent('${article.article_id}')">
                        <i class="fas fa-share-alt"></i>
                    </button>
                </div>
                <div class="comments-container" id="comments-${article.article_id}"></div>
            `;

            return card;
        }

        window.handleReaction = async function(articleId, reactionType) {
            try {
                const { data: existing } = await supabase
                    .from('article_reactions')
                    .select('reaction_id, reaction_type')
                    .eq('article_id', articleId)
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (existing) {
                    await supabase.from('article_reactions').delete().eq('reaction_id', existing.reaction_id);
                    
                    if (existing.reaction_type !== reactionType) {
                        await supabase.from('article_reactions').insert({
                            article_id: articleId,
                            user_id: currentUser.id,
                            reaction_type: reactionType
                        });
                        userReactionsCache[articleId] = reactionType;
                    } else {
                        delete userReactionsCache[articleId];
                    }
                } else {
                    await supabase.from('article_reactions').insert({
                        article_id: articleId,
                        user_id: currentUser.id,
                        reaction_type: reactionType
                    });
                    userReactionsCache[articleId] = reactionType;
                }

                await loadUserArticles();
            } catch (error) {
                console.error('Erreur réaction:', error);
            }
        };

        window.toggleComments = async function(articleId) {
            const container = document.getElementById(`comments-${articleId}`);
            if (!container) return;

            container.classList.toggle('show');

            if (container.classList.contains('show') && container.innerHTML.trim() === '') {
                container.innerHTML = '<div class="loader"><div class="spinner"></div></div>';
                try {
                    if (window.CommentsWidget) {
                        await window.CommentsWidget.render(container, articleId, null, currentUser, userProfile);
                    } else {
                        container.innerHTML = '<div class="empty-state"><i class="fas fa-comments"></i><p>Module commentaires indisponible.</p></div>';
                    }
                } catch (error) {
                    console.error('Erreur chargement commentaires:', error);
                    container.innerHTML = '<p style="color: #ff4757; padding: 20px;">Erreur de chargement</p>';
                }
            }
        };

        window.viewReactions = function(articleId) {
            window.location.href = `usereact.html?article_id=${articleId}`;
        };

        window.shareContent = function(articleId) {
            const url = `${window.location.origin}/index.html?article_id=${articleId}`;
            if (navigator.share) {
                navigator.share({
                    title: 'Market - Article',
                    url: url
                }).catch(() => {});
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    alert('✅ Lien copié !');
                });
            }
        };

        // OPTIONS MENU FUNCTIONS
        window.toggleOptions = function(event, articleId) {
            event.stopPropagation();
            const menu = document.getElementById(`options-${articleId}`);
            document.querySelectorAll('.options-menu').forEach(m => {
                if (m !== menu) m.classList.remove('show');
            });
            menu.classList.toggle('show');
        };

        // Fermer les menus au clic extérieur
        document.addEventListener('click', () => {
            document.querySelectorAll('.options-menu').forEach(m => m.classList.remove('show'));
        });

        window.editArticle = function(articleId) {
            window.location.href = `publier.html?id=${articleId}`;
        };

        window.deleteArticle = async function(articleId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cet article ?')) return;
            
            try {
                const { error } = await supabase
                    .from('articles')
                    .delete()
                    .eq('article_id', articleId);
                
                if (error) throw error;
                
                showToast('✅ Article supprimé avec succès');
                await loadUserArticles();
                await loadUserStats();
            } catch (error) {
                console.error('Erreur suppression:', error);
                showToast('❌ Erreur lors de la suppression');
            }
        };

        // TOAST NOTIFICATION
        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: calc(var(--bottom-nav-height) + 24px);
                left: 50%;
                transform: translateX(-50%) translateY(100px);
                background: var(--bg-secondary);
                color: var(--text-primary);
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: var(--shadow-xl);
                z-index: 10000;
                font-weight: 600;
                font-size: 14px;
                transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                border: 1px solid var(--border-color);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.transform = 'translateX(-50%) translateY(0)';
            }, 10);

            setTimeout(() => {
                toast.style.transform = 'translateX(-50%) translateY(100px)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function formatDate(dateString) {
            const d = new Date(dateString);
            const now = new Date();
            const diff = now - d;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'À l\'instant';
            if (minutes < 60) return `Il y a ${minutes} min`;
            if (hours < 24) return `Il y a ${hours}h`;
            if (days < 7) return `Il y a ${days}j`;
            
            return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }

        async function loadNotificationCount() {
            const { count } = await supabase
                .from('notifications')
                .select('*', { count: 'exact', head: true })
                .eq('user_id', currentUser.id)
                .eq('read_status', false);
            
            const badge = document.getElementById('notifBadge');
            if (count > 0) {
                badge.textContent = count > 9 ? '9+' : count;
                badge.style.display = 'block';
            }
        }

        async function loadMessageCount() {
            const { count } = await supabase
                .from('messages')
                .select('*', { count: 'exact', head: true })
                .eq('receiver_id', currentUser.id)
                .eq('read_status', false);
            
            const badge = document.getElementById('messageBadge');
            if (count > 0) {
                badge.textContent = count > 9 ? '9+' : count;
                badge.style.display = 'block';
            }
        }

        function setupRealtimeSubscriptions() {
            supabase.channel('profile_articles')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'articles',
                    filter: `user_id=eq.${currentUser.id}`
                }, () => loadUserArticles())
                .subscribe();

            supabase.channel('profile_reactions')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'article_reactions'
                }, () => {
                    loadUserArticles();
                    loadUserStats();
                })
                .subscribe();

            supabase.channel('profile_comments')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'sessions_commentaires'
                }, () => {
                    loadCommentCounts();
                    loadUserStats();
                })
                .subscribe();

            console.log('✅ Temps réel activé pour le profil');
        }
    </script>
</body>
  </html>
