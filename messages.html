<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; height: 100vh; overflow: hidden; }
        
        .messages-wrapper { height: 100vh; display: flex; flex-direction: column; }
        
        .messages-header { background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .messages-header h1 { color: #333; font-size: 20px; display: flex; align-items: center; gap: 10px; }
        .messages-header h1 i { color: #667eea; }
        
        .header-actions { display: flex; gap: 10px; }
        .action-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: transform 0.2s; font-size: 14px; }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        .action-btn.secondary { background: #f0f0f0; color: #667eea; }
        
        .messages-container { flex: 1; overflow: hidden; background: white; margin: 15px; border-radius: 15px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); display: flex; flex-direction: column; position: relative; }
        
        .chat-area { flex: 1; display: flex; flex-direction: column; min-height: 0; }
        
        .chat-header { padding: 15px 20px; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; gap: 12px; background: #fafbfc; flex-shrink: 0; }
        .chat-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; flex-shrink: 0; }
        .chat-user-info { flex: 1; }
        .chat-user-info h3 { color: #333; font-size: 15px; margin-bottom: 2px; }
        .chat-user-info p { color: #999; font-size: 12px; text-transform: capitalize; }
        
        .chat-messages { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px; display: flex; flex-direction: column; gap: 12px; background: #f5f7fa; min-height: 0; }
        
        .message-bubble { max-width: 75%; padding: 12px 16px; border-radius: 18px; word-wrap: break-word; animation: slideIn 0.3s ease; position: relative; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .message-sent { align-self: flex-end; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-bottom-right-radius: 4px; }
        .message-received { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .message-text { margin-bottom: 5px; line-height: 1.4; font-size: 14px; }
        .message-time { font-size: 10px; opacity: 0.7; display: flex; align-items: center; gap: 4px; }
        .message-image { max-width: 100%; max-height: 250px; border-radius: 12px; margin-top: 8px; cursor: pointer; }
        
        /* Statuts de message */
        .message-status { display: inline-flex; align-items: center; gap: 2px; margin-left: 4px; }
        .message-status i { font-size: 12px; }
        .status-pending { opacity: 0.5; }
        .status-sent { opacity: 0.7; }
        .status-delivered { opacity: 0.9; }
        .status-read { color: #4CAF50; opacity: 1; }
        
        /* Message en attente (hors ligne) */
        .message-pending { opacity: 0.6; position: relative; }
        .message-pending::after { content: ''; position: absolute; top: 50%; left: -10px; transform: translateY(-50%); width: 4px; height: 4px; background: orange; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        /* Indicateur "en train d'√©crire" */
        .typing-indicator { align-self: flex-start; background: white; padding: 12px 16px; border-radius: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: none; animation: slideIn 0.3s ease; }
        .typing-indicator.show { display: block; }
        .typing-dots { display: flex; gap: 4px; }
        .typing-dots span { width: 8px; height: 8px; background: #999; border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.7; } 30% { transform: translateY(-10px); opacity: 1; } }
        
        .chat-input-area { padding: 15px 20px; border-top: 1px solid #e0e0e0; display: flex; gap: 10px; align-items: center; background: white; flex-shrink: 0; }
        .attach-btn { background: #f0f0f0; border: none; color: #667eea; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; cursor: pointer; transition: all 0.3s; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .attach-btn:hover { background: #e0e0e0; transform: scale(1.05); }
        
        .input-wrapper { flex: 1; position: relative; display: flex; align-items: center; }
        .message-input { width: 100%; padding: 12px 18px; border: 2px solid #e0e0e0; border-radius: 25px; font-size: 14px; font-family: inherit; transition: border-color 0.3s; }
        .message-input:focus { outline: none; border-color: #667eea; }
        
        .send-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 16px; flex-shrink: 0; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .send-btn:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .send-btn:active { transform: scale(0.95); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .send-btn:disabled:hover { transform: none; box-shadow: none; }
        
        /* Indicateur de connexion */
        .connection-status { position: fixed; top: 70px; right: 20px; background: #ff9800; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; display: none; align-items: center; gap: 8px; z-index: 1000; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .connection-status.offline { display: flex; }
        .connection-status i { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; background: #f5f7fa; text-align: center; padding: 20px;}
        .empty-state i { font-size: 60px; margin-bottom: 15px; color: #ddd; }
        .empty-state h3 { font-size: 16px; color: #666; margin-bottom: 8px; }
        .empty-state p { font-size: 13px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 20px; width: 95%; max-width: 450px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; animation: modalSlide 0.3s ease; }
        @keyframes modalSlide { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .modal-header { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .modal-header h3 { font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .close-modal { background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 20px; color: white; cursor: pointer; }
        .close-modal:hover { background: rgba(255,255,255,0.3); }
        
        .modal-search { padding: 15px; border-bottom: 1px solid #e0e0e0; }
        .modal-search input { width: 100%; padding: 10px 15px 10px 40px; border: 2px solid #e0e0e0; border-radius: 20px; font-size: 14px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23999" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>') no-repeat 12px center; }
        .modal-search input:focus { outline: none; border-color: #667eea; }
        
        .list-container { flex: 1; overflow-y: auto; }
        .list-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s; }
        .list-item:hover { background: #f8f9ff; }
        .list-item.active { background: #f0f0ff; border-left: 3px solid #667eea; }
        
        .item-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; flex-shrink: 0; }
        .item-info { flex: 1; min-width: 0; }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .item-name { font-weight: 600; color: #333; font-size: 14px; }
        .item-role { font-size: 10px; color: white; background: #764ba2; padding: 2px 8px; border-radius: 8px; text-transform: capitalize; }
        .item-time { font-size: 11px; color: #999; }
        .item-preview { font-size: 12px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-unread { background: #667eea; color: white; border-radius: 10px; padding: 2px 7px; font-size: 10px; font-weight: bold; flex-shrink: 0; }
        
        .loading { text-align: center; padding: 30px; color: #999; }
        .loading i { font-size: 30px; }
        
        .chat-messages::-webkit-scrollbar { width: 8px; }
        .chat-messages::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .chat-messages::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
    </style>
</head>
<body>
    <!-- Indicateur de connexion -->
    <div class="connection-status" id="connection-status">
        <i class="fas fa-sync-alt"></i>
        <span>Reconnexion en cours...</span>
    </div>

    <div class="messages-wrapper">
        <div class="messages-header">
            <h1><i class="fas fa-comments"></i> <span id="header-title">Messagerie</span></h1>
            <div class="header-actions">
                <button class="action-btn secondary" onclick="openConversationsModal()">
                    <i class="fas fa-list"></i>
                    <span>Conversations</span>
                </button>
                <button class="action-btn" onclick="openContactsModal()">
                    <i class="fas fa-user-plus"></i>
                    <span>Nouveau Message</span>
                </button>
            </div>
        </div>

        <div class="messages-container">
            <div class="chat-area" id="chat-area"></div>
        </div>
    </div>

    <div class="modal" id="conversations-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-comments"></i> Conversations</h3>
                <button class="close-modal" onclick="closeModal('conversations-modal')">√ó</button>
            </div>
            <div class="modal-search">
                <input type="text" placeholder="Rechercher une conversation..." id="search-conversations">
            </div>
            <div class="list-container" id="conversations-list"></div>
        </div>
    </div>

    <div class="modal" id="contacts-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-address-book"></i> Tous les contacts</h3>
                <button class="close-modal" onclick="closeModal('contacts-modal')">√ó</button>
            </div>
            <div class="modal-search">
                <input type="text" placeholder="Rechercher un contact..." id="search-contacts">
            </div>
            <div class="list-container" id="contacts-list"></div>
        </div>
    </div>

    <script src="supabaseClient.js"></script>
    <script>
        const { supabase, getCurrentUser } = window.supabaseClient;
        let currentUser = null;
        let currentChatUser = null;
        let messageSubscription = null;
        let typingSubscription = null;
        let conversationsCache = [];
        let contactsCache = [];
        let pendingMessages = []; // Queue pour messages hors-ligne
        let isOnline = navigator.onLine;
        let typingTimeout = null;

        window.addEventListener('DOMContentLoaded', async () => {
            currentUser = await getCurrentUser();
            if (!currentUser) {
                window.location.href = 'connexion.html';
                return;
            }
            await initInterface();
            setupNetworkListeners();
            setupTypingDetection();

            document.getElementById('search-conversations').addEventListener('input', (e) => filterList('conversations', e.target.value));
            document.getElementById('search-contacts').addEventListener('input', (e) => filterList('contacts', e.target.value));
        });

        // ========================================
        // GESTION R√âSEAU
        // ========================================
        function setupNetworkListeners() {
            window.addEventListener('online', () => {
                isOnline = true;
                document.getElementById('connection-status').classList.remove('offline');
                processPendingMessages();
            });

            window.addEventListener('offline', () => {
                isOnline = false;
                document.getElementById('connection-status').classList.add('offline');
            });
        }

        async function processPendingMessages() {
            if (pendingMessages.length === 0) return;
            
            const toSend = [...pendingMessages];
            pendingMessages = [];
            
            for (const msg of toSend) {
                try {
                    await sendMessageToServer(msg.texte, msg.imageUrl, msg.clientId);
                } catch (error) {
                    console.error('√âchec renvoi message:', error);
                    pendingMessages.push(msg);
                }
            }
        }

        // ========================================
        // D√âTECTION "EN TRAIN D'√âCRIRE"
        // ========================================
        function setupTypingDetection() {
            const input = document.getElementById('message-input');
            if (!input) return;

            input.addEventListener('input', () => {
                if (!currentChatUser) return;
                
                clearTimeout(typingTimeout);
                updateTypingStatus(true);
                
                typingTimeout = setTimeout(() => {
                    updateTypingStatus(false);
                }, 2000);
            });
        }

        async function updateTypingStatus(isTyping) {
            if (!currentChatUser) return;
            
            try {
                await supabase.from('typing_status').upsert({
                    user_id: currentUser.id,
                    chat_with_user_id: currentChatUser.user_id,
                    is_typing: isTyping,
                    last_updated: new Date().toISOString()
                }, {
                    onConflict: 'user_id,chat_with_user_id'
                });
            } catch (error) {
                console.error('Erreur typing status:', error);
            }
        }

        function subscribeToTypingStatus() {
            if (!currentChatUser) return;
            
            if (typingSubscription) {
                supabase.removeChannel(typingSubscription);
            }

            typingSubscription = supabase.channel(`typing:${currentChatUser.user_id}`)
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'typing_status',
                    filter: `user_id=eq.${currentChatUser.user_id}`
                }, (payload) => {
                    if (payload.new && payload.new.chat_with_user_id === currentUser.id) {
                        showTypingIndicator(payload.new.is_typing);
                    }
                })
                .subscribe();
        }

        function showTypingIndicator(show) {
            const indicator = document.getElementById('typing-indicator');
            if (!indicator) return;
            
            if (show) {
                indicator.classList.add('show');
                scrollToBottom();
            } else {
                indicator.classList.remove('show');
            }
        }

        // ========================================
        // INTERFACE INITIALE
        // ========================================
        async function initInterface() {
            await loadConversations();
            
            if (conversationsCache.length > 0) {
                const latestConversation = conversationsCache[0];
                openChat(latestConversation.user);
            } else {
                showEmptyState(
                    'Bienvenue dans votre messagerie', 
                    'Ouvrez une conversation existante ou d√©marrez-en une nouvelle en cliquant sur "Nouveau Message".'
                );
            }
        }
        
        async function loadConversations() {
            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('sender_id, receiver_id, texte, image_url, date_created, delivery_status')
                    .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
                    .order('date_created', { ascending: false });

                if (error) throw error;
                if (!messages || messages.length === 0) {
                    conversationsCache = [];
                    return;
                }

                const userIds = new Set(messages.map(msg => msg.sender_id === currentUser.id ? msg.receiver_id : msg.sender_id));
                
                const { data: users, error: usersError } = await supabase
                    .from('users_profile')
                    .select('user_id, prenom, nom, role')
                    .in('user_id', Array.from(userIds));

                if (usersError) throw usersError;

                const usersMap = new Map(users.map(u => [u.user_id, u]));
                const conversations = new Map();

                messages.forEach(msg => {
                    const otherId = msg.sender_id === currentUser.id ? msg.receiver_id : msg.sender_id;
                    if (!conversations.has(otherId) && usersMap.has(otherId)) {
                        conversations.set(otherId, {
                            user: usersMap.get(otherId),
                            lastMessage: msg,
                            unread: 0
                        });
                    }
                    if (conversations.has(otherId) && msg.receiver_id === currentUser.id && msg.delivery_status !== 'read') {
                        conversations.get(otherId).unread++;
                    }
                });

                conversationsCache = Array.from(conversations.values()).sort((a, b) =>
                    new Date(b.lastMessage.date_created) - new Date(a.lastMessage.date_created)
                );

            } catch (error) {
                console.error('Erreur lors du chargement des conversations:', error);
                conversationsCache = [];
            }
        }

        function openConversationsModal() {
            displayConversations(conversationsCache);
            document.getElementById('conversations-modal').classList.add('show');
        }

        function displayConversations(conversations) {
            const container = document.getElementById('conversations-list');
            if (conversations.length === 0) {
                container.innerHTML = '<div class="loading"><p>Aucune conversation</p></div>';
                return;
            }

            container.innerHTML = conversations.map(conv => {
                const initials = `${conv.user.prenom[0] || ''}${conv.user.nom[0] || ''}`.toUpperCase();
                const lastMsg = conv.lastMessage.image_url ? 'üì∑ Image' : (conv.lastMessage.texte || '').substring(0, 30);
                const time = formatTime(conv.lastMessage.date_created);
                const roleTag = conv.user.role !== 'user' ? `<span class="item-role">${conv.user.role}</span>` : '';
                
                return `
                    <div class="list-item ${currentChatUser && currentChatUser.user_id === conv.user.user_id ? 'active' : ''}" onclick="selectConversation('${conv.user.user_id}')">
                        <div class="item-avatar">${initials}</div>
                        <div class="item-info">
                            <div class="item-header">
                                <span class="item-name">${conv.user.prenom} ${conv.user.nom}</span>
                                ${roleTag}
                                <span class="item-time">${time}</span>
                            </div>
                            <div class="item-preview">${escapeHtml(lastMsg)}</div>
                        </div>
                        ${conv.unread > 0 ? `<div class="item-unread">${conv.unread}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function selectConversation(userId) {
            const conv = conversationsCache.find(c => c.user.user_id === userId);
            if (conv) {
                closeModal('conversations-modal');
                openChat(conv.user);
            }
        }
        
        async function loadContacts() {
            try {
                const { data, error } = await supabase
                    .from('users_profile')
                    .select('user_id, prenom, nom, role')
                    .neq('user_id', currentUser.id)
                    .order('prenom');

                if (error) throw error;
                contactsCache = data || [];
            } catch (error) {
                console.error('Erreur lors du chargement des contacts:', error);
                contactsCache = [];
            }
        }

        async function openContactsModal() {
            const modal = document.getElementById('contacts-modal');
            const list = document.getElementById('contacts-list');
            
            list.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Chargement...</p></div>';
            modal.classList.add('show');
            
            await loadContacts();
            displayContacts(contactsCache);
        }

        function displayContacts(contacts) {
            const container = document.getElementById('contacts-list');
            if (contacts.length === 0) {
                container.innerHTML = '<div class="loading"><p>Aucun contact trouv√©</p></div>';
                return;
            }
            container.innerHTML = contacts.map(user => {
                const initials = `${user.prenom[0] || ''}${user.nom[0] || ''}`.toUpperCase();
                const roleTag = user.role !== 'user' ? `<span class="item-role">${user.role}</span>` : '';
                return `
                    <div class="list-item" onclick="selectContact('${user.user_id}')">
                        <div class="item-avatar">${initials}</div>
                        <div class="item-info">
                            <div class="item-header">
                                <span class="item-name">${user.prenom} ${user.nom}</span>
                                ${roleTag}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectContact(userId) {
            const user = contactsCache.find(c => c.user_id === userId);
            if (user) {
                closeModal('contacts-modal');
                openChat(user);
            }
        }
        
        function filterList(type, query) {
            const lowerQuery = query.toLowerCase();
            const data = type === 'conversations' ? conversationsCache : contactsCache;
            const filtered = data.filter(item => {
                const user = item.user || item;
                return `${user.prenom} ${user.nom}`.toLowerCase().includes(lowerQuery);
            });
            if (type === 'conversations') displayConversations(filtered);
            else displayContacts(filtered);
        }

        // ========================================
        // OUVERTURE CHAT ET CHARGEMENT MESSAGES
        // ========================================
        async function openChat(user) {
            if (currentChatUser && currentChatUser.user_id === user.user_id) return;
            currentChatUser = user;

            const initials = `${user.prenom[0] || ''}${user.nom[0] || ''}`.toUpperCase();
            document.getElementById('chat-area').innerHTML = `
                <div class="chat-header">
                    <div class="chat-avatar">${initials}</div>
                    <div class="chat-user-info">
                        <h3>${user.prenom} ${user.nom}</h3>
                        <p>${user.role}</p>
                    </div>
                </div>
                <div class="chat-messages" id="chat-messages">
                    <div class="typing-indicator" id="typing-indicator">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="file" id="image-input" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                    <button class="attach-btn" title="Joindre une image" onclick="document.getElementById('image-input').click()"><i class="fas fa-paperclip"></i></button>
                    <div class="input-wrapper">
                        <input type="text" class="message-input" id="message-input" placeholder="Votre message..." onkeypress="handleKeyPress(event)" autocomplete="off">
                    </div>
                    <button class="send-btn" onclick="sendMessage()" id="send-btn" disabled><i class="fas fa-paper-plane"></i></button>
                </div>
            `;

            document.getElementById('message-input').addEventListener('input', () => {
                updateSendButtonState();
                setupTypingDetection();
            });
            updateSendButtonState();

            await loadMessages(user.user_id);
            await markMessagesAsRead(user.user_id);
            subscribeToMessages(user.user_id);
            subscribeToTypingStatus();
        }

        async function loadMessages(otherUserId) {
            const container = document.getElementById('chat-messages');
            if (!container) return;
            
            const typingIndicator = container.querySelector('#typing-indicator');
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i></div>';

            try {
                const { data, error } = await supabase
                    .from('messages')
                    .select('message_id, sender_id, texte, image_url, date_created, delivery_status, client_id')
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${otherUserId}),and(sender_id.eq.${otherUserId},receiver_id.eq.${currentUser.id})`)
                    .order('date_created', { ascending: true });

                if (error) throw error;
                displayMessages(data);
                
                // R√©ins√©rer l'indicateur de typing
                if (typingIndicator) {
                    container.appendChild(typingIndicator);
                }
            } catch (error) {
                console.error('Erreur chargement messages:', error);
                container.innerHTML = '<p style="text-align:center;color:#999;">Erreur de chargement</p>';
            }
        }

        function displayMessages(messages) {
            const container = document.getElementById('chat-messages');
            if (!container) return;
            
            const typingIndicator = container.querySelector('#typing-indicator');
            
            container.innerHTML = messages.map(msg => {
                const isSent = msg.sender_id === currentUser.id;
                const isPending = msg.delivery_status === 'pending';
                
                let content = '';
                if (msg.texte) content += `<div class="message-text">${escapeHtml(msg.texte)}</div>`;
                if (msg.image_url) content += `<img src="${msg.image_url}" class="message-image" onclick="window.open('${msg.image_url}', '_blank')">`;
                
                let statusIcon = '';
                if (isSent) {
                    statusIcon = getStatusIcon(msg.delivery_status);
                }
                
                content += `<div class="message-time">${formatTime(msg.date_created)}${statusIcon}</div>`;
                
                return `<div class="message-bubble ${isSent ? 'message-sent' : 'message-received'} ${isPending ? 'message-pending' : ''}" data-message-id="${msg.message_id}" data-client-id="${msg.client_id || ''}">${content}</div>`;
            }).join('');
            
            // R√©ins√©rer l'indicateur de typing
            if (typingIndicator) {
                container.appendChild(typingIndicator);
            }
            
            scrollToBottom();
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'pending':
                    return '<span class="message-status status-pending"><i class="fas fa-clock"></i></span>';
                case 'sent':
                    return '<span class="message-status status-sent"><i class="fas fa-check"></i></span>';
                case 'delivered':
                    return '<span class="message-status status-delivered"><i class="fas fa-check-double"></i></span>';
                case 'read':
                    return '<span class="message-status status-read"><i class="fas fa-check-double"></i></span>';
                default:
                    return '';
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-messages');
            if (container) {
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 100);
            }
        }

        // ========================================
        // ENVOI DE MESSAGES (AVEC GESTION HORS-LIGNE)
        // ========================================
        async function sendMessage(imageFile = null) {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const texte = input ? input.value.trim() : '';

            if (!texte && !imageFile) return;

            const clientId = generateClientId();

            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            // Afficher imm√©diatement le message localement
            addMessageToUI({
                message_id: clientId,
                client_id: clientId,
                sender_id: currentUser.id,
                texte: texte || null,
                image_url: null,
                date_created: new Date().toISOString(),
                delivery_status: isOnline ? 'sent' : 'pending'
            });

            if (input) {
                input.value = '';
                input.focus();
            }

            try {
                let imageUrl = null;
                if (imageFile) {
                    const fileName = `public/${currentUser.id}/${Date.now()}_${imageFile.name}`;
                    const { error: uploadError } = await supabase.storage.from('messages-images').upload(fileName, imageFile);
                    if (uploadError) throw uploadError;
                    const { data } = supabase.storage.from('messages-images').getPublicUrl(fileName);
                    imageUrl = data.publicUrl;
                }

                if (isOnline) {
                    await sendMessageToServer(texte, imageUrl, clientId);
                } else {
                    // Ajouter √† la queue hors-ligne
                    pendingMessages.push({ texte, imageUrl, clientId });
                }
            } catch (error) {
                console.error('Erreur envoi message:', error);
                updateMessageStatus(clientId, 'pending');
                if (isOnline) {
                    alert('Erreur lors de l\'envoi du message');
                }
            } finally {
                if (sendBtn) {
                    sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    updateSendButtonState();
                }
            }
        }

        async function sendMessageToServer(texte, imageUrl, clientId) {
            const { data, error } = await supabase.from('messages').insert({
                sender_id: currentUser.id,
                receiver_id: currentChatUser.user_id,
                texte: texte || null,
                image_url: imageUrl,
                client_id: clientId,
                delivery_status: 'sent'
            }).select();

            if (error) throw error;
            
            // Mettre √† jour l'UI avec l'ID r√©el du serveur
            if (data && data[0]) {
                updateMessageInUI(clientId, data[0]);
            }
        }

        function generateClientId() {
            return `client_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        function addMessageToUI(message) {
            const container = document.getElementById('chat-messages');
            if (!container) return;

            const isSent = message.sender_id === currentUser.id;
            const isPending = message.delivery_status === 'pending';
            
            let content = '';
            if (message.texte) content += `<div class="message-text">${escapeHtml(message.texte)}</div>`;
            if (message.image_url) content += `<img src="${message.image_url}" class="message-image" onclick="window.open('${message.image_url}', '_blank')">`;
            
            let statusIcon = '';
            if (isSent) {
                statusIcon = getStatusIcon(message.delivery_status);
            }
            
            content += `<div class="message-time">${formatTime(message.date_created)}${statusIcon}</div>`;
            
            const messageElement = document.createElement('div');
            messageElement.className = `message-bubble ${isSent ? 'message-sent' : 'message-received'} ${isPending ? 'message-pending' : ''}`;
            messageElement.setAttribute('data-message-id', message.message_id);
            messageElement.setAttribute('data-client-id', message.client_id || '');
            messageElement.innerHTML = content;
            
            // Ins√©rer avant l'indicateur de typing
            const typingIndicator = container.querySelector('#typing-indicator');
            if (typingIndicator) {
                container.insertBefore(messageElement, typingIndicator);
            } else {
                container.appendChild(messageElement);
            }
            
            scrollToBottom();
        }

        function updateMessageInUI(clientId, serverMessage) {
            const messageElement = document.querySelector(`[data-client-id="${clientId}"]`);
            if (messageElement) {
                messageElement.setAttribute('data-message-id', serverMessage.message_id);
                messageElement.classList.remove('message-pending');
                
                // Mettre √† jour le statut
                const statusElement = messageElement.querySelector('.message-status');
                if (statusElement) {
                    statusElement.outerHTML = getStatusIcon(serverMessage.delivery_status);
                }
            }
        }

        function updateMessageStatus(messageId, newStatus) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) return;
            
            const statusElement = messageElement.querySelector('.message-status');
            if (statusElement) {
                statusElement.outerHTML = getStatusIcon(newStatus);
            }
            
            if (newStatus === 'pending') {
                messageElement.classList.add('message-pending');
            } else {
                messageElement.classList.remove('message-pending');
            }
        }

        // ========================================
        // SUBSCRIPTION TEMPS R√âEL
        // ========================================
        function subscribeToMessages(otherUserId) {
            if (messageSubscription) {
                supabase.removeChannel(messageSubscription);
            }

            messageSubscription = supabase.channel(`messages:chat_with_${otherUserId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages',
                    filter: `sender_id=eq.${otherUserId}`
                }, (payload) => {
                    if (payload.new.receiver_id === currentUser.id) {
                        addMessageToUI(payload.new);
                        markMessagesAsRead(otherUserId);
                        loadConversations();
                    }
                })
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'messages'
                }, (payload) => {
                    // Mise √† jour du statut (delivered/read)
                    if (payload.new.sender_id === currentUser.id) {
                        updateMessageStatus(payload.new.message_id, payload.new.delivery_status);
                    }
                })
                .subscribe();
        }

        async function markMessagesAsRead(otherUserId) {
            try {
                await supabase.from('messages')
                    .update({ 
                        delivery_status: 'read',
                        read_status: true,
                        read_at: new Date().toISOString()
                    })
                    .eq('sender_id', otherUserId)
                    .eq('receiver_id', currentUser.id)
                    .in('delivery_status', ['sent', 'delivered']);

                const conv = conversationsCache.find(c => c.user.user_id === otherUserId);
                if (conv) conv.unread = 0;
            } catch (error) {
                console.error('Erreur marquage lu:', error);
            }
        }

        // ========================================
        // UTILITAIRES
        // ========================================
        function updateSendButtonState() {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            if (!input || !sendBtn) return;
            const hasText = input.value.trim().length > 0;
            sendBtn.disabled = !hasText;
        }

        function showEmptyState(title, subtitle = '') {
            document.getElementById('chat-area').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <h3>${title}</h3>
                    <p>${subtitle}</p>
                </div>
            `;
        }
        
        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            if (diff < 60000) return '√Ä l\'instant';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}min`;
            if (date.toDateString() === now.toDateString()) return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { 
                    alert('L\'image est trop volumineuse (max 5MB)'); 
                    return; 
                }
                sendMessage(file);
            }
            event.target.value = null;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function closeModal(modalId) { 
            document.getElementById(modalId).classList.remove('show'); 
        }
        
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) { 
                if (e.target === this) closeModal(this.id); 
            });
        });
        
        window.addEventListener('beforeunload', () => {
            if (messageSubscription) supabase.removeChannel(messageSubscription);
            if (typingSubscription) supabase.removeChannel(typingSubscription);
        });

    </script>
</body>
    </html>
